<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Mobilný e-podpis – Signature Pad (Szymon Nowak)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/l10n/sk.css">
  <style>
    :root {
      --bg: #ffffff;
      --fg: #000000;
      --muted: #444444;
      --accent: #0057ff;
      --ok: #28a745;
      --warn: #ffb020;
      --danger: #e5534b;
      --card: #ffffff;
      --border: #cccccc;
      --radius: 14px;
    }

    html, body {
      margin:0; padding:0;
      background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height:100%;
      overflow-y:auto;
    }

    .wrap { max-width: 880px; margin: 0 auto; padding: 14px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: var(--radius); padding: 12px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .btn { appearance:none; border:1px solid var(--border); background:#eeeeee; color:#000; padding:10px 14px; border-radius: 12px; font-weight:600; cursor:pointer; }
    .btn.primary { background: var(--accent); color:#fff; border-color: transparent; }
    .btn.ok { background: var(--ok); color:#fff; }
    .btn.warn { background: var(--warn); color:#fff; }
    .btn.danger { background: var(--danger); color:#fff; }

    form label { display:block; font-size: 13px; margin: 8px 2px 4px; }
    form input { width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); }

    table.preview { width:100%; border-collapse: collapse; }
    table.preview td { padding: 8px 10px; border-bottom:1px dashed var(--border); }

    /* Modal podpisu */
    #sigModal {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.98);
      display: none;
      z-index: 9999;
      overflow-y:auto;
    }

    #sigCanvas {
      width:100%; height:100%;
      background: transparent !important;
      touch-action:none;
    }
  </style>

</head>

<body>
<div class="wrap">
  <h1>Podpísanie PDF – Mobilná verzia</h1>


  <!-- PDF NAVRCHU -->
  <div class="card" id="pdfCard">
    <div id="pdfLoading">Načítavam PDF…</div>
    <canvas id="pdfCanvas"></canvas>
    <button id="btnFill" class="btn primary" style="margin-top:8px">Vyplniť údaje</button>
  </div>

  <!-- FORMULÁR -->
  <div class="card" id="formCard" style="display:none">
    <form id="theForm"></form>
    <div class="row" style="margin-top:10px">
      <button id="btnConfirmData" class="btn ok">Potvrdiť údaje</button>
      <button id="btnCancelForm" class="btn">Zrušiť</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="card" id="previewCard" style="display:none">
    <div id="previewTableWrap"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnEdit" class="btn warn">Opraviť údaje</button>
      <button id="btnSign" class="btn primary">Podpísať</button>
    </div>
  </div>

  <!-- MODAL PODPISU -->
  <div id="sigModal">
    <div style="padding:10px; display:flex; justify-content:space-between;">
      <div style="font-weight:700">Podpis</div>
      <button id="btnCloseSig" class="btn">Zavrieť</button>
    </div>

    <div style="height:65vh; padding:10px;">
      <canvas id="sigCanvas"></canvas>
    </div>

    <div style="padding:10px; display:flex; gap:10px;">
      <button id="btnClearSig" class="btn danger">Vymazať</button>
      <button id="btnConfirmSig" class="btn ok">Potvrdiť podpis</button>
    </div>
  </div>

  <!-- VÝSLEDOK -->
  <div class="card" id="result" style="display:none">
    <a id="downloadLink" class="btn ok" download="vyplnene_podpisane.pdf">Stiahnuť PDF</a>
  </div>
</div>

<embed id="pdfPreview" type="application/pdf"
       style="width:100%; height:600px; border:1px solid #ccc; margin-top:10px; display:none;">


<!-- PDF.js -->
<script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
<script>
  // korektná inicializácia – funguje 100% na GitHube
  var pdfjsLib = window['pdfjsLib'];
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js";
</script>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<!-- Signature Pad (Szymon Nowak) -->
<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/sk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<script>
/* PDF URL – ponechávam tvoju hodnotu */
const PDF_URL = 'sample.pdf';

/* FORM FIELDS */
const FORM_FIELDS = [
  { key: 'meno',   label: 'Meno a priezvisko', type: 'text', required: true },
  { key: 'adresa', label: 'Adresa',           type: 'text', required: true },
  { key: 'rc',     label: 'Rodné číslo',      type: 'text', required: true },
  { key: 'miesto', label: 'Miesto podpisu',   type: 'text', required: true },
  { key: 'datum',  label: 'Dátum',            type: 'text', required: true }
];

/* ✅ RENDER PDF NAVRCHU – FINÁLNA FUNKČNÁ VERZIA */
async function renderTopPDF(url = PDF_URL) {
  try {
    const pdfCanvas = document.getElementById('pdfCanvas');
    const pdfCtx    = pdfCanvas.getContext('2d');
    const loading   = document.getElementById('pdfLoading');

    loading.textContent = 'Načítavam PDF…';

    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);

    // šírka cardu pre mobil
    const cardWidth = document.getElementById('pdfCard').clientWidth - 20;

    const unscaled = page.getViewport({ scale: 1 });
    const scale = cardWidth / unscaled.width;

    const viewport = page.getViewport({ scale });

    const dpr = window.devicePixelRatio || 1;

    // CSS rozmery – aby to bolo široké presne ako spodný náhľad
    pdfCanvas.style.width = viewport.width + 'px';
    pdfCanvas.style.height = viewport.height + 'px';

    // reálne rozmery (pre ostrosť)
    pdfCanvas.width = viewport.width * dpr;
    pdfCanvas.height = viewport.height * dpr;

    const renderContext = {
      canvasContext: pdfCtx,
      viewport,
      transform: [dpr, 0, 0, dpr, 0, 0]
    };

    await page.render(renderContext).promise;

    loading.style.display = 'none';

  } catch (e) {
    document.getElementById('pdfLoading').textContent =
      'Chyba pri načítaní PDF: ' + e.message;
  }
}

renderTopPDF();

/* ==============================
      FORM – BUILD & PREVIEW
============================== */

const theForm = document.getElementById('theForm');

function buildForm(){
  theForm.innerHTML = '';
  FORM_FIELDS.forEach(f => {
    const id = "f_" + f.key;
    theForm.innerHTML += `
      <label for="${id}">${f.label}</label>
      <input id="${id}" name="${f.key}" type="${f.type}" ${f.required ? 'required' : ''}>
    `;
  });
}

// ✅ Flatpickr pre slovenský kalendár s formátom DD.MM.YYYY
function initFlatpickr() {
  flatpickr("#f_datum", {
    dateFormat: "d.m.Y",
    allowInput: true,
    locale: "sk"
  });
}

function getFormData(){
  const data = {};
  FORM_FIELDS.forEach(f => {
  let value = document.querySelector(`[name="${f.key}"]`).value;



data[f.key] = value; 
  });
  return data;
}

document.getElementById('btnFill').onclick = () => {
  buildForm();
  initFlatpickr();
  document.getElementById('formCard').style.display = 'block';
  document.getElementById('previewCard').style.display = 'none';
  document.getElementById('result').style.display = 'none';
};

document.getElementById('btnCancelForm').onclick = () => {
  document.getElementById('formCard').style.display = 'none';
};

document.getElementById('btnConfirmData').onclick = (e)=>{
  e.preventDefault();
  if(!theForm.reportValidity()) return;

  const data = getFormData();

  // Preformátujeme dátum YYYY-MM-DD -> DD.MM.YYYY
  if (data.datum) {
    const parts = data.datum.split("-");
    data.datum = `${parts[2]}.${parts[1]}.${parts[0]}`;
  }

  let rows = '';
  FORM_FIELDS.forEach(f=>{
    rows += `<tr><td>${f.label}</td><td>${data[f.key]}</td></tr>`;
  });

  document.getElementById('previewTableWrap').innerHTML =
    `<table class='preview'>${rows}</table>`;

  document.getElementById('formCard').style.display = 'none';
  document.getElementById('previewCard').style.display = 'block';
};

document.getElementById('btnEdit').onclick = ()=>{
  document.getElementById('previewCard').style.display = 'none';
  document.getElementById('formCard').style.display = 'block';
};


/* ==============================
      SIGNATURE PAD – MODAL
============================== */

let signaturePad;
const sigModal  = document.getElementById('sigModal');
const sigCanvas = document.getElementById('sigCanvas');

document.getElementById('btnSign').onclick = ()=>{
  sigModal.style.display = 'block';
  resizeSigCanvas();

  signaturePad = new SignaturePad(sigCanvas, {
    minWidth: 0.7,
    maxWidth: 2.7,
    penColor: '#0057ff',               // ✅ modrý podpis
    backgroundColor: 'rgba(0,0,0,0)'   // ✅ priehľadné pozadie
  });

  document.body.style.overflow = "hidden"; // fix pre mobil
};

document.getElementById('btnCloseSig').onclick = ()=>{
  sigModal.style.display = 'none';
  document.body.style.overflow = "";
};

document.getElementById('btnClearSig').onclick = ()=>{
  if(signaturePad) signaturePad.clear();
};

function resizeSigCanvas(){
  const ratio = window.devicePixelRatio || 1;
  sigCanvas.width  = sigCanvas.clientWidth * ratio;
  sigCanvas.height = sigCanvas.clientHeight * ratio;
  sigCanvas.getContext('2d').scale(ratio, ratio);
}

window.onresize = ()=>{
  if(sigModal.style.display === 'block'){
    resizeSigCanvas();
  }
};


/* ==============================
      FINAL PDF EXPORT
============================== */

document.getElementById('btnConfirmSig').onclick = async()=>{

  if(signaturePad.isEmpty()){
    alert("Podpis je prázdny.");
    return;
  }

  // zatvor modal
  sigModal.style.display = 'none';
  document.body.style.overflow = "";

  const sigDataUrl = signaturePad.toDataURL('image/png');

  // načítaj pôvodné PDF
  const existingPdfBytes = await fetch(PDF_URL).then(r=>r.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
  const page   = pdfDoc.getPages()[0];

  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
  const data = getFormData();


  /* ==========
      VLOŽENIE ÚDAJOV DO PDF
     ========== */

  // ❗ Toto sú len UKÁŽKOVÉ pozície — TY si ich doladíš podľa svojho PDF
  // napravo za dvojbodku, ako si chcel
  const fieldsXY = {
    meno:   {x: 150, y: 705},
    adresa: {x: 150, y: 685},
    rc:     {x: 150, y: 665},
    miesto: {x: 150, y: 645},
    datum:  {x: 150, y: 625}
  };

  for(const f of FORM_FIELDS){
    const xy = fieldsXY[f.key];
    if(!xy) continue;

    page.drawText(String(data[f.key] || ""), {
      x: xy.x,
      y: xy.y,
      size: 12,
      font,
      color: PDFLib.rgb(0,0,0)
    });
  }


  /* ==========
      VLOŽENIE PODPISU
     ========== */

  const pngImage = await pdfDoc.embedPng(sigDataUrl);
  const pngDims  = pngImage.scale(0.6);

  // podpis medzi "splnomocniteľ" a bodkami — TY si upravíš
  page.drawImage(pngImage, {
    x: 200,     // ✔ približné miesto
    y: 520,     // ✔ uprav si podľa potreby
    width:  pngDims.width,
    height: pngDims.height
  });


  /* ==========
      ULOŽENIE PDF
     ========== */

const pdfBytes = await pdfDoc.save();
const url = URL.createObjectURL(
  new Blob([pdfBytes], { type: 'application/pdf' })
);
await renderTopPDF(url);


// ✅ PRIAME STIAHNUTIE BEZ OTVORENIA
const a = document.createElement("a");
a.href = url;
a.download = "vyplnene_podpisane.pdf";
document.body.appendChild(a);
a.click();
document.body.removeChild(a);

// ✅ zobrazíme panel s tlačidlom (pre istotu)
document.getElementById('downloadLink').href = url;
document.getElementById('result').style.display = 'block';


}; // ✅ toto uzatvára btnConfirmSig funkciu
</script>  <!-- ✅ toto MUSÍ zostať ako koniec scriptu -->
