
<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Mobiln√Ω e-podpis ‚Äì Signature Pad (Szymon Nowak)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/l10n/sk.css">
  <style>
    :root {
      --bg: #D4B483;
      --fg: #000000;
      --muted: #444444;
      --accent: #0057ff;
      --ok: #28a745;
      --warn: #ffb020;
      --danger: #e5534b;
      --card: #ffffff;
      --border: #cccccc;
      --radius: 14px;
    }

    html, body {
      margin:0; padding:0;
      background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      height:100%;
      overflow-y:auto;
    }

    .wrap { max-width: 880px; margin: 0 auto; padding: 14px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: var(--radius); padding: 12px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .btn { appearance:none; border:1px solid var(--border); background:#eeeeee; color:#000; padding:10px 14px; border-radius: 12px; font-weight:600; cursor:pointer; }
    .btn.primary { background: var(--accent); color:#fff; border-color: transparent; }
    .btn.ok { background: var(--ok); color:#fff; }
    .btn.warn { background: var(--warn); color:#fff; }
    .btn.danger { background: var(--danger); color:#fff; }

    form label { display:block; font-size: 13px; margin: 8px 2px 4px; }
    form input { width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); }

    table.preview { width:100%; border-collapse: collapse; }
    table.preview td { padding: 8px 10px; border-bottom:1px dashed var(--border); }

    /* Modal podpisu */
    #sigModal {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.98);
      display: none;
      z-index: 9999;
      overflow-y:auto;
    }

    /* ‚úÖ Nov√Ω r√°mƒçek + podklad pre podpis */
    #sigBox {
      width: 100%;
      border: 2px solid #666;
      border-radius: 8px;
      padding: 10px;
      background: #fafafa;
    }

    /* ‚úÖ Pl√°tno na podpis + podpisov√° ƒçiara */
    #sigCanvas {
      width: 100%;
      height: 245px;
      background: transparent !important;
      touch-action: none;
      display: block;
      border-bottom: 2px solid #000; /* ƒçiara na podpis */
    }
  </style>
  
  
</head>

<body>
<div class="wrap">
 

  <!-- PDF NAVRCHU -->
  <div class="card" id="pdfCard">
    <div id="pdfLoading">Naƒç√≠tavam PDF‚Ä¶</div>
    <canvas id="pdfCanvas"></canvas>
    <button id="btnFill" class="btn primary" style="margin-top:8px">Vyplni≈• √∫daje</button>
  </div>

  <!-- FORMUL√ÅR -->
  <div class="card" id="formCard" style="display:none">
    <form id="theForm"></form>
    <div class="row" style="margin-top:10px">
      <button id="btnConfirmData" class="btn ok">Potvrdi≈• √∫daje</button>
      <button id="btnCancelForm" class="btn">Zru≈°i≈•</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="card" id="previewCard" style="display:none">
    <div id="previewTableWrap"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnEdit" class="btn warn">Opravi≈• √∫daje</button>
      <button id="btnSign" class="btn primary">Podp√≠sa≈•</button>
    </div>
  </div>

  <!-- MODAL PODPISU -->
  <div id="sigModal">
    <div style="padding:10px; display:flex; justify-content:space-between;">
      <div style="font-weight:700">Podpis</div>
      <button id="btnCloseSig" class="btn">Zavrie≈•</button>
    </div>

    <div style="height:50vh; padding:10px;">

  <!-- ‚úÖ Nov√Ω r√°mƒçek + podpisov√° ƒçiara -->
  <div id="sigBox">
    <canvas id="sigCanvas"></canvas>
  </div>

</div>

    <div style="padding:10px; display:flex; gap:10px;">
      <button id="btnClearSig" class="btn danger">Vymaza≈•</button>
      <button id="btnConfirmSig" class="btn ok">Potvrdi≈• podpis</button>
    </div>
  </div>

  <!-- V√ùSLEDOK -->
  <div class="card" id="result" style="display:none; gap:10px;">
    <button onclick="downloadPDF()" class="btn ok">Stiahnu≈• PDF</button>
    <button onclick="closePage()" class="btn" 
            style="background:#ccc; border-color:#bbb; width:130px; font-weight:600;">
      Zavrie≈•
    </button>
  </div>
</div>

<embed id="pdfPreview" type="application/pdf"
       style="width:100%; height:600px; border:1px solid #ccc; margin-top:10px; display:none;">


<!-- PDF.js -->
<script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
<script>
  // korektn√° inicializ√°cia ‚Äì funguje 100% na GitHube
  var pdfjsLib = window['pdfjsLib'];
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js";
</script>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<!-- Signature Pad (Szymon Nowak) -->
<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/sk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  emailjs.init("BDiw7IJQiDnlCYFPX");
</script>

<script>
/* PDF URL ‚Äì ponech√°vam tvoju hodnotu */
const PDF_URL = 'sample.pdf';

const FORM_FIELDS = [
  { key: 'meno',   label: 'Meno a priezvisko', type: 'text', required: true },

  // üîπ Nov√© rozdelen√© polia pre adresu
  { key: 'ulica',  label: 'Ulica', type: 'text', required: true },
  { key: 'cislo',  label: 'ƒå√≠slo domu', type: 'text', required: true },
  { key: 'psc',    label: 'Smerov√© ƒç√≠slo', type: 'text', required: true },
  { key: 'mesto',  label: 'Mesto', type: 'text', required: true },

  // üîπ Automaticky sa vytvor√≠ cel√© spojenie adresy (nezobraz√≠ sa vo formul√°ri)
  { key: 'adresa', label: 'Trval√Ω pobyt', type: 'hidden' },

  { key: 'rc',     label: 'Rodn√© ƒç√≠slo',      type: 'text', required: true },
  { key: 'miesto', label: 'Podp√≠san√© v meste', type: 'text', required: true },
  { key: 'datum',  label: 'D√°tum',            type: 'text', required: true }
];

/* ‚úÖ RENDER PDF NAVRCHU ‚Äì FIN√ÅLNA FUNKƒåN√Å VERZIA */
async function renderTopPDF(url = PDF_URL) {
  try {
    const pdfCanvas = document.getElementById('pdfCanvas');
    const pdfCtx    = pdfCanvas.getContext('2d');
    const loading   = document.getElementById('pdfLoading');

    loading.textContent = 'Naƒç√≠tavam PDF‚Ä¶';

    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);

    // ≈°√≠rka cardu pre mobil
    const cardWidth = document.getElementById('pdfCard').clientWidth - 20;

    const unscaled = page.getViewport({ scale: 1 });
    const scale = cardWidth / unscaled.width;

    const viewport = page.getViewport({ scale });

    const dpr = window.devicePixelRatio || 1;

    // CSS rozmery ‚Äì aby to bolo ≈°irok√© presne ako spodn√Ω n√°hƒæad
    pdfCanvas.style.width = viewport.width + 'px';
    pdfCanvas.style.height = viewport.height + 'px';

    // re√°lne rozmery (pre ostros≈•)
    pdfCanvas.width = viewport.width * dpr;
    pdfCanvas.height = viewport.height * dpr;

    const renderContext = {
      canvasContext: pdfCtx,
      viewport,
      transform: [dpr, 0, 0, dpr, 0, 0]
    };

    await page.render(renderContext).promise;

    loading.style.display = 'none';

  } catch (e) {
    document.getElementById('pdfLoading').textContent =
      'Chyba pri naƒç√≠tan√≠ PDF: ' + e.message;
  }
}

renderTopPDF();

/* ==============================
      FORM ‚Äì BUILD & PREVIEW
============================== */

const theForm = document.getElementById('theForm');

function buildForm(){
  theForm.innerHTML = '';
  FORM_FIELDS.forEach(f => {
    const id = "f_" + f.key;
    theForm.innerHTML += `
      <label for="${id}">${f.label}</label>
      <input id="${id}" name="${f.key}" type="${f.type}" ${f.required ? 'required' : ''}>
    `;
  });
}

// ‚úÖ Flatpickr pre slovensk√Ω kalend√°r s form√°tom DD.MM.YYYY
function initFlatpickr() {
  flatpickr("#f_datum", {
    dateFormat: "d.m.Y",
    allowInput: true,
    locale: "sk"
  });
}

function getFormData(){
  const data = {};
  FORM_FIELDS.forEach(f => {
  data.adresa = `${data.ulica} ${data.cislo}, ${data.psc} ${data.mesto}`;
  let value = document.querySelector(`[name="${f.key}"]`).value;



data[f.key] = value; 
  });
  return data;
}

document.getElementById('btnFill').onclick = () => {
  buildForm();
  initFlatpickr();
  document.getElementById('formCard').style.display = 'block';
  document.getElementById('previewCard').style.display = 'none';
  document.getElementById('result').style.display = 'none';
};

document.getElementById('btnCancelForm').onclick = () => {
  document.getElementById('formCard').style.display = 'none';
};

document.getElementById('btnConfirmData').onclick = (e)=>{
  e.preventDefault();
  if(!theForm.reportValidity()) return;

  const data = getFormData();

  

  let rows = '';
FORM_FIELDS.forEach(f => {
  if (['ulica','cislo','psc','mesto'].includes(f.key)) return; // tieto polia preskoƒç√≠me
  rows += `<tr><td>${f.label}</td><td>${data[f.key]}</td></tr>`;
});

  document.getElementById('previewTableWrap').innerHTML =
    `<table class='preview'>${rows}</table>`;

  document.getElementById('formCard').style.display = 'none';
  document.getElementById('previewCard').style.display = 'block';
};

document.getElementById('btnEdit').onclick = ()=>{
  document.getElementById('previewCard').style.display = 'none';
  document.getElementById('formCard').style.display = 'block';
};


/* ==============================
      SIGNATURE PAD ‚Äì MODAL
============================== */

let signaturePad;
const sigModal  = document.getElementById('sigModal');
const sigCanvas = document.getElementById('sigCanvas');

document.getElementById('btnSign').onclick = ()=>{
  sigModal.style.display = 'block';
  resizeSigCanvas();

  signaturePad = new SignaturePad(sigCanvas, {
    minWidth: 0.9,
    maxWidth: 2.2,
    penColor: '#58389c',               // ‚úÖ modr√Ω podpis
    backgroundColor: 'rgba(0,0,0,0)'   // ‚úÖ priehƒæadn√© pozadie
  });

  document.body.style.overflow = "hidden"; // fix pre mobil
};

document.getElementById('btnCloseSig').onclick = ()=>{
  sigModal.style.display = 'none';
  document.body.style.overflow = "";
};

document.getElementById('btnClearSig').onclick = ()=>{
  if(signaturePad) signaturePad.clear();
};

function resizeSigCanvas(){
   const ratio = (window.devicePixelRatio || 1) * 2.5;   // zv√Ω≈°en√© DPI
  sigCanvas.width  = sigCanvas.clientWidth * ratio;
  sigCanvas.height = sigCanvas.clientHeight * ratio;
  sigCanvas.getContext('2d').scale(ratio, ratio);
}

window.onresize = ()=>{
  if(sigModal.style.display === 'block'){
    resizeSigCanvas();
  }
};


/* ==============================
      FINAL PDF EXPORT
============================== */

document.getElementById('btnConfirmSig').onclick = async()=>{

  if(signaturePad.isEmpty()){
    alert("Podpis je pr√°zdny.");
    return;
  }

  // zatvor modal
  sigModal.style.display = 'none';
  document.body.style.overflow = "";

  const sigDataUrl = signaturePad.toDataURL('image/png');

  // naƒç√≠taj p√¥vodn√© PDF
  const existingPdfBytes = await fetch(PDF_URL).then(r=>r.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
  const page   = pdfDoc.getPages()[0];

  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
  const data = getFormData();


  /* ==========
      VLO≈ΩENIE √öDAJOV DO PDF
     ========== */

  // ‚ùó Toto s√∫ len UK√Å≈ΩKOV√â poz√≠cie ‚Äî TY si ich dolad√≠≈° podƒæa svojho PDF
  // napravo za dvojbodku, ako si chcel
  const fieldsXY = {
    meno:   {x: 170, y: 696},
    adresa: {x: 170, y: 673},
    rc:     {x: 170, y: 650},
    miesto: {x: 280, y: 265},
    datum:  {x: 118, y: 265}
  };

  for(const f of FORM_FIELDS){
    const xy = fieldsXY[f.key];
    if(!xy) continue;

    page.drawText(String(data[f.key] || ""), {
      x: xy.x,
      y: xy.y,
      size: 12,
      font,
      color: PDFLib.rgb(0,0,0)
    });
  }


  /* ==========
      VLO≈ΩENIE PODPISU
     ========== */

  const pngImage = await pdfDoc.embedPng(sigDataUrl);

// Pevn√° veƒækos≈• podpisu v PDF (napr. 120 √ó 40 px)
const SIGN_W = 170;
const SIGN_H = 60;

page.drawImage(pngImage, {
  x: 75,  
  y: 140,
  width:  SIGN_W,
  height: SIGN_H
});


/* ==========
      ULO≈ΩENIE PDF
     ========== */
const pdfBytes = await pdfDoc.save();
const url = URL.createObjectURL(
  new Blob([pdfBytes], { type: 'application/pdf' })
);

// ‚úÖ ulo≈æ√≠me URL GLOB√ÅLNE
window.pdfURL = url;
window.pdfBytes = pdfBytes; // potrebujeme pre email

// ‚úÖ N√ÅHƒΩAD + TLAƒåIDL√Å
const msg = document.createElement('div');
msg.style.cssText = `
  position: fixed;
  inset: 0;
  background: #D4B483;
  color: #000;
  display: flex;
  flex-direction: column;
  z-index: 99999;
  overflow-y: auto;
`;

msg.innerHTML = `
  <div style="
    padding: 15px;
    background: white;
    border-bottom: 2px solid #ccc;
    text-align: center;
    font-size: 20px;
    font-weight: 700;
  ">
    ‚úÖ N√°hƒæad vyplnen√©ho PDF
  </div>
  
  <div style="
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #D4B483;
  ">
    <canvas id="finalPdfCanvas" style="
      width: 100%;
      border: 2px solid #666;
      border-radius: 8px;
      background: white;
      display: block;
      margin: 0 auto;
    "></canvas>
  </div>
  
  <div style="
    padding: 15px;
    background: white;
    border-top: 2px solid #ccc;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  ">
    <button id="btnDownloadNow" style="
      padding: 15px 35px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    ">üì• Stiahnu≈• PDF</button>
    
    <button id="btnCloseNow" style="
      padding: 15px 35px;
      background: #ccc;
      color: #000;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    ">‚úñÔ∏è Zavrie≈•</button>
  </div>
  
  <div id="emailStatus" style="
    padding: 10px;
    text-align: center;
    font-size: 14px;
    color: #666;
  ">
    üìß Odosielam na email...
  </div>
`;

document.body.appendChild(msg);

// ‚úÖ VYRENDERUJ FIN√ÅLNE PDF NA CANVAS
async function renderFinalPDF() {
  try {
    const canvas = document.getElementById('finalPdfCanvas');
    const ctx = canvas.getContext('2d');
    
    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    
    const containerWidth = canvas.parentElement.clientWidth - 20;
    const unscaled = page.getViewport({ scale: 1 });
    const scale = containerWidth / unscaled.width;
    const viewport = page.getViewport({ scale });
    
    const dpr = window.devicePixelRatio || 1;
    
    canvas.style.width = viewport.width + 'px';
    canvas.style.height = viewport.height + 'px';
    canvas.width = viewport.width * dpr;
    canvas.height = viewport.height * dpr;
    
    await page.render({
      canvasContext: ctx,
      viewport,
      transform: [dpr, 0, 0, dpr, 0, 0]
    }).promise;
    
  } catch (e) {
    console.error('Chyba pri renderovan√≠ PDF:', e);
  }
}

await renderFinalPDF();

// ‚úÖ AUTOMATICK√â ODOSLANIE NA EMAIL
async function sendEmailWithPDF() {
  try {
    const data = getFormData();
    
    // konvertuj PDF na base64
    const base64PDF = btoa(
      new Uint8Array(window.pdfBytes)
        .reduce((data, byte) => data + String.fromCharCode(byte), '')
    );
    
    const templateParams = {
      user_name: data.meno,
      user_rc: data.rc,
      user_adresa: data.adresa,
      user_miesto: data.miesto,
      user_datum: data.datum,
      pdf_file: base64PDF,
      pdf_filename: 'podpisany_dokument.pdf'
    };
                 
   await fetch("https://reef-winter-pure-jury.trycloudflare.com/send_mail", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(templateParams)
});

    
    document.getElementById('emailStatus').innerHTML = 
      '‚úÖ Email bol √∫spe≈°ne odoslan√Ω!';
    document.getElementById('emailStatus').style.color = '#28a745';
    
  } catch (error) {
    console.error('Chyba pri odosielan√≠ emailu:', error);
    document.getElementById('emailStatus').innerHTML = 
      '‚ö†Ô∏è Email sa nepodarilo odosla≈•';
    document.getElementById('emailStatus').style.color = '#e5534b';
  }
}

// spusti odosielanie na pozad√≠
sendEmailWithPDF();

// ‚úÖ STIAHNUTIE
document.getElementById('btnDownloadNow').onclick = () => {
  const a = document.createElement('a');
  a.href = window.pdfURL;
  a.download = 'vyplnene_podpisane.pdf';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  msg.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 20px;
    ">
      <div style="font-size: 24px; font-weight: 700; margin-bottom: 30px;">
        ‚úÖ PDF bolo stiahnut√©!
      </div>
      <button onclick="closePage()" style="
        padding: 15px 35px;
        background: #ccc;
        color: #000;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
      ">‚úñÔ∏è Zavrie≈• str√°nku</button>
    </div>
  `;
};

// ‚úÖ ZATVORENIE
document.getElementById('btnCloseNow').onclick = () => {
  window.open('', '_self');
  window.close();
  
  setTimeout(() => {
    document.body.innerHTML = `
      <div style="
        padding:30px;
        font-size:24px;
        text-align:center;
        font-weight:600;
      ">
        Hotovo ‚úÖ<br>
        Str√°nku m√¥≈æete zavrie≈•.<br><br>
        <img src="logo.png"
             style="width:160px; margin-top:15px; opacity:0.9;">
      </div>
    `;
  }, 100);
};

}; // koniec btnConfirmSig


/* ==============================
   FUNKCIA PRE ZATVORENIE (z√°lo≈æn√°)
============================== */

function closePage() {
  window.open('', '_self');
  window.close();

  setTimeout(() => {
    document.body.innerHTML = `
      <div style="
        padding:30px;
        font-size:24px;
        text-align:center;
        font-weight:600;
      ">
        Hotovo ‚úÖ<br>
        Str√°nku m√¥≈æete zavrie≈•.<br><br>
        <img src="logo.png"
             style="width:160px; margin-top:15px; opacity:0.9;">
      </div>
    `;
  }, 100);
}
</script>
