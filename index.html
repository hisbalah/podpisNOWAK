<script>
// ✅ Nastav PDF URL
const PDF_URL = 'sample.pdf';

// ✅ Polia formulára
const FORM_FIELDS = [
  { key: 'meno', label: 'Meno a priezvisko', type: 'text', required: true },
  { key: 'adresa', label: 'Adresa', type: 'text', required: true },
  { key: 'rc', label: 'Rodné číslo', type: 'text', required: true },
  { key: 'miesto', label: 'Miesto podpisu', type: 'text', required: true },
  { key: 'datum', label: 'Dátum', type: 'date', required: true }
];

/* =================== PDF ZOBRAZENIE =================== */
async function renderTopPDF() {
  try {
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');
    const loading = document.getElementById('pdfLoading');

    const doc = await pdfjsLib.getDocument(PDF_URL).promise;
    const page = await doc.getPage(1);

    const viewport = page.getViewport({ scale: window.innerWidth / 600 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;
    loading.style.display='none';
  } catch (e) {
    document.getElementById('pdfLoading').innerHTML = "Chyba: " + e;
  }
}
renderTopPDF();

/* =================== FORMULÁR =================== */
const theForm = document.getElementById('theForm');

function buildForm(){
  theForm.innerHTML='';
  FORM_FIELDS.forEach(f=>{
    theForm.innerHTML += `
      <label>${f.label}</label>
      <input name="${f.key}" type="${f.type}" ${f.required?'required':''}>
    `;
  });
}

function getFormData(){
  const d={};
  FORM_FIELDS.forEach(f=> d[f.key] = document.querySelector(`[name="${f.key}"]`).value );
  return d;
}

document.getElementById('btnFill').onclick = ()=>{
  buildForm();
  document.getElementById('formCard').style.display='block';
};

document.getElementById('btnConfirmData').onclick = e=>{
  e.preventDefault();
  if(!theForm.reportValidity()) return;

  const data=getFormData();
  let rows='';
  FORM_FIELDS.forEach(f=>{
    rows += `<tr><td>${f.label}</td><td>${data[f.key]}</td></tr>`;
  });

  document.getElementById('previewTableWrap').innerHTML =
    `<table class="preview">${rows}</table>`;

  document.getElementById('formCard').style.display='none';
  document.getElementById('previewCard').style.display='block';
};

document.getElementById('btnEdit').onclick = ()=>{
  document.getElementById('previewCard').style.display='none';
  document.getElementById('formCard').style.display='block';
};

/* =================== PODPIS =================== */
let signaturePad;
const sigModal = document.getElementById('sigModal');
const sigCanvas = document.getElementById('sigCanvas');

document.getElementById('btnSign').onclick = ()=>{
  sigModal.style.display='block';
  resizeSigCanvas();
  signaturePad = new SignaturePad(sigCanvas,{
    minWidth:0.7,
    maxWidth:2.7,
    penColor:'#0057ff',                 // ✅ modrý podpis
    backgroundColor:'rgba(0,0,0,0)'     // ✅ priehľadné pozadie
  });
};

document.getElementById('btnCloseSig').onclick = ()=> sigModal.style.display='none';
document.getElementById('btnClearSig').onclick = ()=> signaturePad.clear();

function resizeSigCanvas(){
  const ratio = window.devicePixelRatio || 1;
  sigCanvas.width = sigCanvas.clientWidth * ratio;
  sigCanvas.height = sigCanvas.clientHeight * ratio;
  sigCanvas.getContext('2d').scale(ratio, ratio);
}

window.onresize = ()=>{
  if(sigModal.style.display === 'block') resizeSigCanvas();
};

/* =================== GENEROVANIE PDF =================== */
document.getElementById('btnConfirmSig').onclick = async()=>{
  if(signaturePad.isEmpty()) return alert("Podpis je prázdny.");

  const sig = signaturePad.toDataURL("image/png");
  sigModal.style.display='none';

  const existing = await fetch(PDF_URL).then(r=>r.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(existing);
  const page = pdfDoc.getPages()[0];
  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

  const data = getFormData();

  /* ✅ Približné umiestnenie údajov */
  const positions = {
    meno:    { x: 180, y: 695 },
    adresa:  { x: 180, y: 675 },
    rc:      { x: 180, y: 655 },
    miesto:  { x: 180, y: 635 },
    datum:   { x: 180, y: 615 }
  };

  for(const f of FORM_FIELDS){
    const p = positions[f.key];
    page.drawText(data[f.key], {
      x: p.x,
      y: p.y,
      size: 12,
      font,
      color: PDFLib.rgb(0,0,0)
    });
  }

  /* ✅ Podpis – približné umiestnenie */
  const png = await pdfDoc.embedPng(sig);
  const dims = png.scale(0.35);  // ✅ správna veľkosť podpisu

  page.drawImage(png,{
    x: 250,    // približne pod "splnomocniteľ"
    y: 130,    // upravíš podľa PDF
    width: dims.width,
    height: dims.height
  });

  /* ✅ Export */
  const pdfBytes = await pdfDoc.save();
  const url = URL.createObjectURL(new Blob([pdfBytes],{type:'application/pdf'}));

  document.getElementById('downloadLink').href = url;
  document.getElementById('result').style.display='block';
};
</script>
